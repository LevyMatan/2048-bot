# Run 8K regression guard using the TDL (n-tuple network) player.
# Trains the network from scratch, then benchmarks 8K hit rate.
name: Benchmark 8K regression

on:
  workflow_dispatch:
    inputs:
      train_episodes:
        description: 'Training episodes'
        default: '100000'
      num_games:
        description: 'Benchmark games'
        default: '100'
      threshold:
        description: 'Min 8K hit rate (0-1)'
        default: '0.10'
  schedule:
    - cron: '0 2 * * 0'   # weekly Sunday 02:00 UTC

jobs:
  regression:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - uses: actions/checkout@v3

    - name: Build C++ 2048
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++
        cd cpp && mkdir -p build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make 2048

    - name: Run 8K regression check (TDL)
      env:
        TRAIN_EPISODES: ${{ github.event.inputs.train_episodes || '100000' }}
        TRAIN_THREADS: '4'
        BENCHMARK_THREADS: '4'
      run: |
        cd cpp
        chmod +x scripts/check_8k_regression.sh
        scripts/check_8k_regression.sh \
          ${{ github.event.inputs.threshold || '0.10' }} \
          ${{ github.event.inputs.num_games || '100' }} \
          configurations/tdl_config.json
